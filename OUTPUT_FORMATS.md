# Output File Formats

This document describes all output files generated by the five simulation methods in ClassicalSpin_Cpp.

## Table of Contents

1. [Simulated Annealing](#1-simulated-annealing)
2. [Parallel Tempering](#2-parallel-tempering)
3. [Molecular Dynamics](#3-molecular-dynamics)
4. [Pump-Probe](#4-pump-probe)
5. [2D Coherent Spectroscopy (2DCS)](#5-2d-coherent-spectroscopy-2dcs)
6. [Parameter Sweep](#6-parameter-sweep)

---

## 1. Simulated Annealing

**Output Directory Structure:**
```
<output_dir>/
└── sample_<trial>/
    ├── positions.txt
    ├── spins.txt
    ├── final_energy.txt
    ├── energy.txt          (if save_observables=true)
    ├── magnetization.txt   (if save_observables=true)
    └── spins_final.dat     (if save_observables=true)
```

### Text Files

#### `positions.txt`
Site positions in Cartesian coordinates.
```
<x_0> <y_0> <z_0>
<x_1> <y_1> <z_1>
...
<x_N-1> <y_N-1> <z_N-1>
```
- Format: Space-separated, scientific notation with 16 digits precision
- Dimensions: `[N_sites, 3]`

#### `spins.txt`
Final spin configuration.
```
<S_0_x> <S_0_y> <S_0_z>
<S_1_x> <S_1_y> <S_1_z>
...
```
- Format: Space-separated spin components per line
- Dimensions: `[N_sites, spin_dim]` where `spin_dim=3` for SU(2), `spin_dim=8` for SU(3)

#### `final_energy.txt`
```
Energy Density: <value>
```

#### `energy.txt` (observables)
Energy per site at each temperature step.
```
<E/N at T_1>
<E/N at T_2>
...
```

#### `magnetization.txt` (observables)
Magnetization vector at each temperature step.
```
<M_x> <M_y> <M_z>
...
```

---

## 2. Parallel Tempering

**Output Directory Structure:**
```
<output_dir>/
├── rank_<r>/
│   ├── parallel_tempering_data.h5  (HDF5 format, if enabled)
│   ├── observables_summary.txt     (text format, optional)
│   ├── energy.txt                  (text format, optional)
│   └── ...                         (additional text files, optional)
├── parallel_tempering_aggregated.h5 (rank 0 only, HDF5)
└── heat_capacity.txt                (rank 0 only, text)
```

**Note:** When compiled with `-DHDF5_ENABLED`, parallel tempering uses a structured HDF5 format
to minimize file count. See [PARALLEL_TEMPERING_HDF5.md](PARALLEL_TEMPERING_HDF5.md) for detailed
documentation of the HDF5 format.

### HDF5 Files (Preferred Format)

#### `rank_<r>/parallel_tempering_data.h5`
Single comprehensive file per replica containing all simulation data.

**Structure:**
```
/timeseries/
├── energy                  [n_samples]
├── magnetization          [n_samples, spin_dim]
└── sublattice_mag_<α>     [n_samples, spin_dim] for each sublattice

/observables/
├── energy_mean
├── energy_error
├── specific_heat_mean
├── specific_heat_error
├── sublattice_mag_<α>_mean    [spin_dim]
├── sublattice_mag_<α>_error   [spin_dim]
└── ... (cross-correlations)

/metadata/
└── (simulation parameters as attributes)
```

See [PARALLEL_TEMPERING_HDF5.md](PARALLEL_TEMPERING_HDF5.md) for complete details and examples.

#### `parallel_tempering_aggregated.h5`
Temperature-dependent data across all replicas (created by rank 0).

**Structure:**
```
/temperature_scan/
├── temperature           [n_temperatures]
├── specific_heat        [n_temperatures]
└── specific_heat_error  [n_temperatures]
```

### Text Files (Legacy/Optional Format)

When HDF5 is not available or text output is explicitly enabled:

#### `heat_capacity.txt`
Heat capacity vs temperature (saved by rank 0 only).
```
# T C_V dC_V
<T_0> <C_V_0> <dC_V_0>
<T_1> <C_V_1> <dC_V_1>
...
```
- `T`: Temperature
- `C_V`: Heat capacity per site
- `dC_V`: Statistical error estimate

#### `rank_<r>/energy.txt`
Energy time series for replica at rank `r`.
```
<E/N at step 0>
<E/N at step 1>
...
```

#### `rank_<r>/magnetization.txt`
Magnetization time series for replica at rank `r`.
```
<M_x> <M_y> <M_z>
...
```

#### `rank_<r>/spins_final.dat`
Final spin configuration (same format as `spins.txt`).

---

## 3. Molecular Dynamics

**Output Directory Structure:**
```
<output_dir>/
└── sample_<trial>/
    └── trajectory.h5
```

### HDF5 File: `trajectory.h5`

**File Structure:**
```
/trajectory/
├── times                    [n_steps]
├── spins                    [n_steps, n_sites, spin_dim]
├── magnetization_antiferro  [n_steps, spin_dim]
├── magnetization_local      [n_steps, spin_dim]
└── magnetization_global     [n_steps, spin_dim]

/metadata/
├── lattice_size             (attribute)
├── spin_dim                 (attribute)
├── n_atoms                  (attribute)
├── dimensions               [3] - (dim1, dim2, dim3)
├── integration_method       (attribute) - e.g., "dopri5", "rk4"
├── dt_initial               (attribute)
├── T_start                  (attribute)
├── T_end                    (attribute)
├── save_interval            (attribute)
├── spin_length              (attribute)
├── creation_time            (attribute) - ISO 8601 format
├── code_version             (attribute)
├── file_format              (attribute) - "HDF5_MD_v1.0"
└── positions                [n_sites, 3] (optional)
```

#### Dataset Descriptions

| Dataset | Shape | Description |
|---------|-------|-------------|
| `times` | `[n_steps]` | Time points in simulation units |
| `spins` | `[n_steps, n_sites, spin_dim]` | Full spin configuration at each time |
| `magnetization_antiferro` | `[n_steps, spin_dim]` | Staggered magnetization (AFM order parameter) |
| `magnetization_local` | `[n_steps, spin_dim]` | Average magnetization per site |
| `magnetization_global` | `[n_steps, spin_dim]` | Global magnetization (sublattice-frame transformed) |

### Mixed Lattice (SU2+SU3): `trajectory_mixed.h5`

For TmFeO3 or other mixed lattices with both SU(2) and SU(3) spins:

```
/trajectory_SU2/
├── times                    [n_steps]
├── spins                    [n_steps, n_sites_SU2, 3]
├── magnetization_antiferro  [n_steps, 3]
├── magnetization_local      [n_steps, 3]
└── magnetization_global     [n_steps, 3]

/trajectory_SU3/
├── times                    [n_steps]
├── spins                    [n_steps, n_sites_SU3, 8]
├── magnetization_antiferro  [n_steps, 8]
├── magnetization_local      [n_steps, 8]
└── magnetization_global     [n_steps, 8]

/metadata_SU2/
├── lattice_size             (attribute)
├── spin_dim                 (attribute) = 3
├── n_atoms                  (attribute)
├── spin_length              (attribute)
└── positions                [n_sites_SU2, 3]

/metadata_SU3/
├── lattice_size             (attribute)
├── spin_dim                 (attribute) = 8
├── n_atoms                  (attribute)
├── spin_length              (attribute)
└── positions                [n_sites_SU3, 3]

/metadata_global/
├── integration_method       (attribute)
├── dt_initial               (attribute)
├── T_start                  (attribute)
├── T_end                    (attribute)
├── save_interval            (attribute)
├── creation_time            (attribute)
├── code_version             (attribute)
├── file_format              (attribute) - "HDF5_Mixed_MD_v1.0"
└── dimensions               [3]
```

---

## 4. Pump-Probe

**Output Directory Structure:**
```
<output_dir>/
└── sample_<trial>/
    ├── trajectory.h5
    └── pump_probe_trajectory.txt
```

### Text File: `pump_probe_trajectory.txt`

Simple text output for quick analysis:
```
<time> <M_AF_x> <M_AF_y> <M_AF_z> <M_local_x> <M_local_y> <M_local_z> <M_global_x> <M_global_y> <M_global_z>
...
```

Columns:
1. Time
2-4. Antiferromagnetic magnetization (Sx, Sy, Sz)
5-7. Local magnetization (Sx, Sy, Sz)
8-10. Global magnetization (Sx, Sy, Sz)

### HDF5 File: `trajectory.h5`

Same structure as Molecular Dynamics output (see Section 3).

---

## 5. 2D Coherent Spectroscopy (2DCS)

**Output Directory Structure:**
```
<output_dir>/
└── sample_<trial>/
    └── pump_probe_spectroscopy.h5
```

### HDF5 File: `pump_probe_spectroscopy.h5`

**File Structure:**
```
/metadata/
├── creation_time            (attribute)
├── experiment_type          (attribute) - "pump_probe_spectroscopy"
├── code_version             (attribute)
├── file_format              (attribute) - "HDF5_PumpProbe_v1.0"
│
├── # Lattice parameters
├── lattice_size             (attribute)
├── spin_dim                 (attribute)
├── n_atoms                  (attribute)
├── dim1, dim2, dim3         (attributes)
├── spin_length              (attribute)
│
├── # Pulse parameters
├── pulse_amp                (attribute)
├── pulse_width              (attribute)
├── pulse_freq               (attribute)
│
├── # Time evolution
├── T_start                  (attribute) - MD start time
├── T_end                    (attribute) - MD end time
├── T_step                   (attribute) - save interval
├── integration_method       (attribute)
│
├── # Delay scan
├── tau_start                (attribute)
├── tau_end                  (attribute)
├── tau_step                 (attribute)
├── tau_steps                (attribute) - number of tau points
│
├── # Ground state info
├── ground_state_energy      (attribute)
├── ground_state_magnetization (attribute)
├── Temp_start               (attribute) - annealing start T
├── Temp_end                 (attribute) - annealing end T
├── n_anneal                 (attribute)
│
├── # Optional
├── pulse_field_direction    [n_atoms, spin_dim]
└── positions                [n_sites, 3]

/reference/
├── times                    [n_times]
├── M_antiferro              [n_times, spin_dim]
├── M_local                  [n_times, spin_dim]
└── M_global                 [n_times, spin_dim]

/tau_scan/
├── tau_values               [n_tau]
└── tau_<i>/                 (for each delay time i=0,1,2,...)
    ├── tau_value            (attribute)
    ├── M1_antiferro         [n_times, spin_dim]
    ├── M1_local             [n_times, spin_dim]
    ├── M1_global            [n_times, spin_dim]
    ├── M01_antiferro        [n_times, spin_dim]
    ├── M01_local            [n_times, spin_dim]
    └── M01_global           [n_times, spin_dim]
```

#### Understanding the 2DCS Data

| Dataset | Description |
|---------|-------------|
| `/reference/M_*` | **M₀(t)**: Response to single pump pulse at t=0 |
| `/tau_scan/tau_<i>/M1_*` | **M₁(t,τ)**: Response to probe-only pulse at delay τ |
| `/tau_scan/tau_<i>/M01_*` | **M₀₁(t,τ)**: Response to both pump and probe pulses |

**Nonlinear Signal Extraction:**
```python
# The nonlinear signal is computed as:
M_NL(t, tau) = M01(t, tau) - M0(t) - M1(t, tau)
```

### Mixed Lattice (SU2+SU3): `pump_probe_spectroscopy_mixed.h5`

Extends the above with separate SU2 and SU3 sections:

```
/metadata_SU2/
/metadata_SU3/
/metadata_global/

/reference_SU2/
├── times, M_antiferro, M_local, M_global    [for SU2 spins]

/reference_SU3/
├── times, M_antiferro, M_local, M_global    [for SU3 spins]

/tau_scan/
└── tau_<i>/
    ├── M1_SU2_antiferro, M1_SU2_local, M1_SU2_global
    ├── M01_SU2_antiferro, M01_SU2_local, M01_SU2_global
    ├── M1_SU3_antiferro, M1_SU3_local, M1_SU3_global
    └── M01_SU3_antiferro, M01_SU3_local, M01_SU3_global
```

---

## 6. Parameter Sweep

Parameter sweep wraps any of the above simulation methods, organizing outputs by parameter values.

**Output Directory Structure:**
```
<output_dir>/
└── <param1>_<value1>/
    └── <param2>_<value2>/
        └── ... (base simulation outputs)
```

For example, a 2D sweep over `field_strength` and `temperature`:
```
output/
├── field_strength_1.000000e-01/
│   └── temperature_1.000000e+00/
│       └── sample_0/
│           └── (simulation outputs)
├── field_strength_2.000000e-01/
│   └── temperature_1.000000e+00/
│       └── sample_0/
│           └── (simulation outputs)
...
```

---

## Python Reader Example

A reference Python reader is provided in `util/readers_new/reader_pyrochlore.py`.

### Reading Molecular Dynamics HDF5

```python
import h5py
import numpy as np

with h5py.File('trajectory.h5', 'r') as f:
    # Read metadata
    lattice_size = f['/metadata'].attrs['lattice_size']
    spin_dim = f['/metadata'].attrs['spin_dim']
    
    # Read trajectory data
    times = f['/trajectory/times'][:]
    spins = f['/trajectory/spins'][:]  # [n_steps, n_sites, spin_dim]
    M_local = f['/trajectory/magnetization_local'][:]
    M_antiferro = f['/trajectory/magnetization_antiferro'][:]
    M_global = f['/trajectory/magnetization_global'][:]
    
    # Read positions if available
    if 'positions' in f['/metadata']:
        positions = f['/metadata/positions'][:]
```

### Reading 2DCS Spectroscopy HDF5

```python
import h5py
import numpy as np

with h5py.File('pump_probe_spectroscopy.h5', 'r') as f:
    # Read reference trajectory (M0)
    times = f['/reference/times'][:]
    M0_local = f['/reference/M_local'][:]
    M0_antiferro = f['/reference/M_antiferro'][:]
    
    # Read tau values
    tau_values = f['/tau_scan/tau_values'][:]
    
    # Read data for specific tau
    tau_idx = 0
    tau_group = f[f'/tau_scan/tau_{tau_idx}']
    M1_local = tau_group['M1_local'][:]
    M01_local = tau_group['M01_local'][:]
    
    # Compute nonlinear signal
    M_NL = M01_local - M0_local - M1_local
```

---

## Data Compression

All HDF5 files use:
- **Chunked storage** for efficient reading of time slices
- **DEFLATE compression** (level 6) to reduce file sizes
- **Expandable datasets** for streaming writes during simulation

Typical compression ratios: 2-10x depending on data entropy.

---

## Units

All quantities are in natural units where:
- Spin length |S| = 1 (or as specified by `spin_length` parameter)
- Energy scale set by exchange coupling J = 1
- Time in units of ℏ/J
